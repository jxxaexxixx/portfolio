{% extends "index.html" %}
{% block content %}
<link rel="stylesheet" href="{{DomainUri}}/source/css/admin.css?v={{ "now"|date("Y-m-d H:i:s") }}">

<style>
:root {
  --maincolor: #725CAD;
  --subcolor: #eee;
  --bgcolor: #3C3C3C;
}
body{
	width: 100vw;
	height: 100vh;
	min-width: 1000px;
	min-height: 600px;
}
.admin_wrap {
  	width: 100%;
  	height: 100%;
  	background-color: var(--bgcolor);
  	display: flex;
  	flex-wrap: wrap;
  	gap: 10px;
  	padding: 15px 25px 5px 25px;
}

.ad_main_txt_box{
	width: 100%;
	height: 35px;
}
.ad_main_txt{
	font-size: 30px;
	color: #fff;
	font-weight: 600;
}

.ad_le_wrap {
  	width: 270px;
  	height: calc(100% - 75px);
  	border: 2px solid var(--maincolor);
  	border-radius: 15px;
}

.ad_ri_wrap {
	width: calc(100% - 280px);
  	height: calc(100% - 75px);
  	border: 2px solid var(--maincolor);
  	border-radius: 15px;
	padding: 10px;
	display: flex;
	justify-content: space-between;
	flex-wrap: wrap;
}
.ad_bot_wrap {
	width: 100%;
	text-align: right;
}
.ad_bot_txt {
	font-size: 12px;
	color: #fff;
}
.ad_chat_list_wrap {
  height: 100%;
  width: 100%;
  padding: 14px 11px;
  overflow-y: scroll;
  scrollbar-width: none; /* Firefox */
}

.ad_chat_list_wrap::-webkit-scrollbar {
  display: none; /* Chrome, Safari */
}
.ad_chat_box{
	width: 100%;
	height: 65px;
	border: 2px solid var(--maincolor);
  	border-radius: 10px;
  	background-color: rgba(92, 79, 127, 0.49);
	margin-bottom: 10px;
	display: flex;
	justify-content: space-between;
}
.ad_chat_box_act{
	background-color: #402b5f;
}

.ad_chat_le_box{width: 65px;}
.ad_chat_le_img{
	display: block;
    width: 100%;
    height: 100%;
    padding: 8px 11px 11px 11px;
	}
.ad_chat_ri_box{
	width: calc(100% - 65px);
	height: 100%;
	display: flex;
	flex-wrap: wrap;
	align-items: initial;
	padding-right: 8px;
}
.ad_chat_ri_top_box{
    padding-top: 5px;
	width: 100%;
	display: flex;
	justify-content: space-between;
	align-items: center;

}

.ad_chat_ri_user_txt{
	overflow: hidden;
	white-space: nowrap;
	text-overflow: ellipsis;
	font-size: 12px;
}
.ad_chat_ri_time_txt{
	font-size: 10px;
	color: #989898;
	min-width: 40px;
	max-width: 40px;
}
.ad_chat_ri_txt{
	font-size: 13px;
}

.ad_chat_ri_bot_box{
	width: 100%;
}

.ad_set_wrap{
	border: 1px solid #646464;
	border-radius: 10px;
	padding: 10px;
	width: 153px;
	height: 100%;
}
.ad_set_box{
	width: 100%;
	height: 39px;
	margin-bottom: 10px;
}
.ad_set_btn{
	display: flex;
	align-items: center;
	width: 100%;
	height: 100%;
	background-color: #fff;
	border-radius: 7px;
	padding-left: 14px;
}
.ad_set_img{
	width: 21px;
	height: 21px;

}
.set_btn_txt{
	font-size: 14px;
	color: #4a4a4a;
	font-weight: 400;
	padding-left: 10px;
}

.ad_set_btn_act{
	background-color: var(--maincolor);
}
.ad_set_btn_act .set_btn_txt{
	color: #fff;
	font-weight: 500;
}
.ad_set_btn_act:hover{
	color: #fff!important;
}

.ad_set_cont_wrap{
	width: calc(100% - 163px);
	display: none;
	height: 100%;

}

.ad_set_cont_user_list_wrap{
	height: 100%;
	width: 100%;
	display: flex;
	justify-content: space-between;
}
.ad_set_cont_wrap_act{
	display: block;
}
.ad_set_user_list_dt_box{
	border: 1px solid #646464;
	border-radius: 10px;
	width: calc(100% - 210px);
	height: 100%;
}
.ad_set_user_list_box{
	border: 1px solid #646464;
	border-radius: 10px;
	width: 200px;
	height: 100%;
	overflow-y: auto;
	scrollbar-width: none;
}

.ad_set_user_list_img_box{
	display: flex;
	align-items: center;
	justify-content: center;
	flex-wrap: wrap;
	padding: 20px 0 0 0;

}

.ad_set_user_list_img{
	width: 160px;
	height: 160px;
}
.ad_set_user_list_txt_box{
	width: 100%;
	text-align: center;
	padding: 35px 10px 0 10px;
}
.ad_set_user_list_txt_box span{
	width: 100%;
}
.ad_set_user_list_txt{
	font-size: 13px;
	color: #fff;
	padding-bottom: 7px;
}
.ad_set_user_list_txt_cont{
	font-size: 15px;
	color: #fff;
	font-weight: 500;
	line-height: 1.3;
}

.user_data_table_wrap{
	width: 100%;
	height: 100%;
	overflow-y: auto;
	padding: 10px;
}

.p_table .p_td_status{
	width: 60px!important;
}
.p_table .td_status_2{
	color: #e16464;
}
.p_table .p_td_createTime{
	width: 160px!important;
}

.ad_ri_exit_wrap{
	width: 100%;
	height: 30px;
	display: flex;
	justify-content: start;
	align-items: start;
	padding-left: 7px;
}
.ad_ri_exit_brn_img{
	width: 30px;
	height: 30px;
	cursor: pointer;
}

.ad_chat_de_box{
	width: 100%;
	height: calc(100% - 45px);
	display: flex;
	justify-content: space-between;
}
.ad_chat_de_cont_box{
	width: calc(100% - 210px);
	height: 100%;
	background-color: #F4F4F4;
	border-radius: 10px;
	padding: 10px;
	display: flex;
	flex-wrap: wrap;
}
.ad_chat_de_cont_chat_box{
	width: 100%;
	height: calc(100% - 100px);
	overflow-y: auto;
	scrollbar-width: none;
	padding: 20px;
}

.chat_msg_box{
	padding-bottom: 30px;
}

.chat_admin_msg_box{
	display: flex;
	align-items: start;
}
.chat_admin_msg_img_box{
	padding-right: 10px;
}
.chat_admin_msg_img{
	width: 40px;
	height: 40px;
}
.chat_admin_msg_sb_box{
	background-color: #DCCFFF;
	border-radius: 10px;
	padding: 15px;
	max-width: 65%;
}
.chat_admin_msg_text{
	font-size: 14px;
	color: #444;
	font-weight: 500;
	line-height: 1.5;
}

.chat_client_msg_box{
	display: flex;
	align-items: start;
	justify-content: flex-end;
}
.chat_client_msg_img_box{
	padding-left: 10px;
}
.chat_client_msg_sb_box{
	background-color: #fff;
	border-radius: 10px;
	padding: 15px;
	max-width: 65%;

}
.chat_client_msg_text{
	font-size: 14px;
	color: #444;
	font-weight: 500;
	line-height: 1.5;
}
.chat_client_msg_img{
	width: 40px;
	height: 40px;
}

.ad_chat_de_cont_send_box{
	width: 100%;
	height: 100px;
	background-color: #fff;
	border: 2px solid var(--maincolor);
	border-radius: 10px;
	padding: 10px 6px 5px 12px;
}
.send_chat{
	width: 100%;
	height: calc(100% - 27px);
	resize: none;
	font-size: 16px;
	color: #333;
	font-weight: 500;

}
.chat_send_btn_box{
	height: 27px;
	display: flex;
	align-items: center;
	justify-content: flex-end;
}














.ellipsis {
	width: 100%; /* 부모 요소의 너비에 맞춤 */
  white-space: nowrap;        /* 줄바꿈 안 함 */
  overflow: hidden;           /* 넘친 내용 숨김 */
  text-overflow: ellipsis;    /* ...으로 표시 */
}
</style>

<div class="admin_wrap">
	<div class="ad_main_txt_box">
		<span class="ad_main_txt">관리자가 되어 채팅을 실시간으로 확인하세요!</span>
	</div>
	<div class="ad_le_wrap">
		<div class="ad_chat_list_wrap">
				{% if chatList %}
					{% for key in chatList %}
						<a href="javascript:void(0);" class="ad_chat_box" data-rn="{{key.rn}}">
							<div class="ad_chat_le_box">
								<img src="{{DomainUri}}/source/img/icons/c_user.png" alt="유저 이미지" class="ad_chat_le_img">
							</div>
							<div class="ad_chat_ri_box">
								<div class="ad_chat_ri_top_box">
									<span class="ad_chat_ri_user_txt f_white ellipsis">{{key.name}}</span>
									<span class="ad_chat_ri_time_txt f_white">{{key.formatted_time}}</span>
								</div>
								<div class="ad_chat_ri_bot_box">
									<span class="ad_chat_ri_txt f_white ellipsis">{{key.last_msg}}</span>
								</div>
							</div>
						</a>
					{% endfor %}
				{% else %}
				{% endif %}
		</div>
	</div>
	<div class="ad_ri_wrap ad_chat_set_wrap">
		<div class="ad_set_wrap">
			<div class="ad_set_box">
				<a href="javascript:void(0);" class="ad_set_btn ad_set_btn_act">
					<img src="{{DomainUri}}/source/img/icons/user.png" alt="회원 목록 아이콘" class="ad_set_img">
					<span class="set_btn_txt">회원 목록</span>
				</a>
			</div>
			<div class="ad_set_box">
				<a href="javascript:void(0);" class="ad_set_btn">
					<img src="{{DomainUri}}/source/img/icons/block_c.png" alt="금지어 설정 아이콘" class="ad_set_img">
					<span class="set_btn_txt">금지어 설정</span>
				</a>
			</div>
			<div class="ad_set_box">
				<a href="javascript:void(0);" class="ad_set_btn">
					<img src="{{DomainUri}}/source/img/icons/chat_c.png" alt="빠른 답변 아이콘" class="ad_set_img">
					<span class="set_btn_txt">빠른 답변</span>
				</a>
			</div>
		</div>
		<div class="ad_set_cont_wrap ad_set_cont_wrap_act">
			<div class="ad_set_cont_user_list_wrap">
				<div class="ad_set_user_list_dt_box">
					<div class=" user_data_table_wrap">
						<div class="p_table_box user_data_table_box">
							<table class="p_table dataTable">
								<thead>
									<th>idx</th>
									<th>회원명</th>
									<th>회원상태</th>
									<th>가입일</th>
								</thead>
								<tbody class="settlement_tbody">
								</tbody>
							</table>
						</div>
					</div>
				</div>
				<div class="ad_set_user_list_box">
					<div class="ad_set_user_list_cont display_none">
						<div class="ad_set_user_list_img_box">
							<img src="{{DomainUri}}/source/img/icons/c_user.png" alt="유저 이미지" class="ad_set_user_list_img">
						</div>
						<div class="ad_set_user_list_txt_box">
							<span class="ad_set_user_list_txt">닉네임</span>
							<span class="ad_set_user_list_txt_cont"></span>
						</div>
						<div class="ad_set_user_list_txt_box">
							<span class="ad_set_user_list_txt">가입일</span>
							<span class="ad_set_user_list_txt_cont"></span>
						</div>
						<div class="ad_set_user_list_txt_box">
							<span class="ad_set_user_list_txt">듣고 싶은 말</span>
							<span class="ad_set_user_list_txt_cont"></span>
						</div>
						<div class="ad_chat_user_de_del_btn_box">
							<a href="javascript:void(0);" class="p_btn user_del_btn">
								<span class="btn_txt">회원삭제</span>
							</a>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="ad_set_cont_wrap ad_set_cont_block_wrap">
			<div class="ad_set_block_dt_box">
			</div>
			<div class="ad_set_block_box">
			</div>
		</div>
		<div class="ad_set_cont_wrap ad_set_cont_quick_wrap">
			<div class="ad_set_quick_dt_box">
			</div>
			<div class="ad_set_quick_box">
			</div>
		</div>
	</div>
	<div class="ad_ri_wrap ad_chat_de_wrap display_none">
		<div class="ad_ri_exit_wrap">
			<a href="javascript:void(0);" class="ad_ri_exit_brn">
				<img src="{{DomainUri}}/source/img/icons/exit.png" alt="나가기" class="ad_ri_exit_brn_img">
			</a>
		</div>
		<div class="ad_chat_de_box">
			<div class="ad_chat_de_cont_box">
				<div class="ad_chat_de_cont_chat_box">
					<div class="chat_admin_msg_box chat_msg_box">
						<div class="chat_admin_msg_img_box">
							<img src="{{DomainUri}}/source/img/icons/c_user.png" alt="유저 이미지" class="chat_admin_msg_img">
						</div>
						<div class="chat_admin_msg_sb_box">
							<span class="chat_admin_msg_text">안녕하세요, 에어팟프로 님!
								저희 포트폴리오에 방문해 주셔서 감사해요.
								우측 내 정보 영역에 듣고 싶은 말을 입력해 저장하시면,
								저와 대화하실 때마다 따뜻하게 전해드릴게요.

								또한, 자동응답 명령어로 다양한 정보를 확인하실 수 있어요.

								!소개 — 제작자 소개
								!스택 — 기술 스택 안내
								!프로젝트 — 참여 프로젝트 목록
								!경험 — 주요 경험 설명
								!연락처 — 연락 방법 안내
								!링크 — 외부 링크 모음
								!포폴 — 포트폴리오 소
							</span>
						</div>
					</div>
					<div class="chat_admin_msg_box chat_msg_box">
						<div class="chat_admin_msg_img_box">
							<img src="{{DomainUri}}/source/img/icons/c_user.png" alt="유저 이미지" class="chat_admin_msg_img">
						</div>
						<div class="chat_admin_msg_sb_box">
							<span class="chat_admin_msg_text">안녕하세요, 에어팟프로 님!
								저희 포트폴리오에 방문해 주셔서 감사해요.
								우측 내 정보 영역에 듣고 싶은 말을 입력해 저장하시면,
								저와 대화하실 때마다 따뜻하게 전해드릴게요.

								또한, 자동응답 명령어로 다양한 정보를 확인하실 수 있어요.

								!소개 — 제작자 소개
								!스택 — 기술 스택 안내
								!프로젝트 — 참여 프로젝트 목록
								!경험 — 주요 경험 설명
								!연락처 — 연락 방법 안내
								!링크 — 외부 링크 모음
								!포폴 — 포트폴리오 소
							</span>
						</div>
					</div>
					<div class="chat_admin_msg_box chat_msg_box">
						<div class="chat_admin_msg_img_box">
							<img src="{{DomainUri}}/source/img/icons/c_user.png" alt="유저 이미지" class="chat_admin_msg_img">
						</div>
						<div class="chat_admin_msg_sb_box">
							<span class="chat_admin_msg_text">안녕하세요, 에어팟프로 님!
								저희 포트폴리오에 방문해 주셔서 감사해요.
								우측 내 정보 영역에 듣고 싶은 말을 입력해 저장하시면,
								저와 대화하실 때마다 따뜻하게 전해드릴게요.

								또한, 자동응답 명령어로 다양한 정보를 확인하실 수 있어요.

								!소개 — 제작자 소개
								!스택 — 기술 스택 안내
								!프로젝트 — 참여 프로젝트 목록
								!경험 — 주요 경험 설명
								!연락처 — 연락 방법 안내
								!링크 — 외부 링크 모음
								!포폴 — 포트폴리오 소
							</span>
						</div>
					</div>
					<div class="chat_client_msg_box chat_msg_box">
						<div class="chat_client_msg_sb_box">
							<span class="chat_client_msg_text">유저양</span>
						</div>
						<div class="chat_client_msg_img_box">
							<img src="{{DomainUri}}/source/img/icons/man.png" alt="유저 이미지" class="chat_client_msg_img">
						</div>
					</div>
				</div>
				<div class="ad_chat_de_cont_send_box">
					<textarea class="send_chat"></textarea>
					<div class="chat_send_btn_box">
						<a href="javascript:void(0);" class="p_btn chat_send_btn">
							<span class="btn_txt">전송</span>
						</a>
					</div>
				</div>
			</div>
			<div class="ad_set_user_list_box ad_chat_de_cont_user_box">
				<div class="ad_set_user_list_cont">
					<div class="ad_set_user_list_img_box">
						<img src="{{DomainUri}}/source/img/icons/c_user.png" alt="유저 이미지" class="ad_set_user_list_img">
					</div>
					<div class="ad_set_user_list_txt_box">
						<span class="ad_set_user_list_txt">닉네임</span>
						<span class="ad_set_user_list_username ad_set_user_list_txt_cont"></span>
					</div>
					<div class="ad_set_user_list_txt_box">
						<span class="ad_set_user_list_txt">가입일</span>
						<span class="ad_set_user_list_createtime ad_set_user_list_txt_cont"></span>
					</div>
					<div class="ad_set_user_list_txt_box">
						<span class="ad_set_user_list_txt">듣고 싶은 말</span>
						<span class="ad_set_user_list_talk ad_set_user_list_txt_cont"></span>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="ad_bot_wrap">
		<span class="ad_bot_txt">해당 사이트는 PC 환경에 최적화되어 있으므로, 데스크톱 또는 노트북에서의 이용을 권장드립니다.</span>
	</div>
</div>
<script type="text/javascript">
$(document).ready(function () {
	const body = $('body');

	var dataTable;
	if (dataTable instanceof $.fn.dataTable.Api) {
	    dataTable.destroy();
		$('.dataTable').DataTable().destroy();
	}
	dataTable=$('.dataTable').DataTable({
	    "order": [[4,'desc']],
	    "iDisplayLength":50,
	    "ajax" : {
	        url:DomainUri+"/AdminCon/ClientDataTable",
	        type:"POST",
	        data:function(d){},
	   	},
	   	"columns": [
	        { "data": "idx", "class":"p_td_idx","orderable": false,"visible":false},
	        { "data": "name", "class":""},
	        { "data": "status", "class":"p_td_status"},
	        { "data": "create_time", "class":"p_td_createTime"},
	        { "data": "talk", "class":"","visible":false},
	    ],
    	"initComplete": function(settings, data, dataIndex){
    		pTableInitComplete(this,'y');

		},
		fnRowCallback: function(nRow, aData, iDisplayIndex, iDisplayIndexFull){
			var tdStatus='';
			if(aData['status']=='정상'){
				tdStatus='td_status_1';
            }else if(aData['status']=='삭제'){
				tdStatus='td_status_2';
            }
			$('.p_td_status', nRow).html('<span class="f_small '+tdStatus+'">'+aData['status']+'</span>');
		},
		drawCallback: function( settings ) {
		},
	});

	// 행 클릭 이벤트 바인딩
 	$('.dataTable tbody').on('click', 'tr', function(){
 	    // 1) 선택된 행의 데이터 가져오기
 	    var data = dataTable.row(this).data();

 	    // 2) 유저 리스트 박스 보여주기
 	    var $box = $('.ad_set_user_list_cont');
 	    $box.removeClass('display_none');

 	    // 3) 텍스트 채우기
 	    $box.find('.ad_set_user_list_username')
 	        .text(data.name);

 	    $box.find('.ad_set_user_list_createtime')
 	        .text(data.create_time);

 	    $box.find('.ad_set_user_list_talk')
 	       .text(data.talk);

 	   	// 4) (옵션) 사용자 이미지 변경하기
 	   	//    data.imageUrl 같은 프로퍼티가 있으면 넣어 주시면 됩니다.
    	// $box.find('.ad_set_user_list_img')
    	//     .attr('src', data.imageUrl || '{{DomainUri}}/source/img/icons/c_user.png');
  	});

	$('.ad_ri_exit_brn').on('click', function(e){
	    e.preventDefault();

	    $('.ad_chat_set_wrap').removeClass('display_none');
	    $('.ad_chat_de_wrap').addClass('display_none');

	    $('.ad_chat_box').removeClass('ad_chat_box_act');
	});


	$('.ad_chat_box').on('click', function(e){
  	  	e.preventDefault();
  	  	var $this = $(this);
  	  	$('.ad_chat_de_wrap').removeClass('display_none');
  	  	$('.ad_chat_set_wrap').addClass('display_none');
  	  	$('.ad_chat_box').removeClass('ad_chat_box_act');
  	  	$this.addClass('ad_chat_box_act');
  	});


	$('.ad_set_btn').on('click', function(e){
	    e.preventDefault();
	    var $this = $(this);
	    // 1) 버튼 활성화 클래스 토글
	    $('.ad_set_btn').removeClass('ad_set_btn_act');
	    $this.addClass('ad_set_btn_act');
	    // 2) 이미지 src 업데이트 (_c 붙였다 떼었다)
	    $('.ad_set_btn').each(function(){
    	  	var $img = $(this).find('.ad_set_img');
    	  	var src  = $img.attr('src');
    	  	if ($(this).hasClass('ad_set_btn_act')) {
    	  	  	// 활성 버튼: _c 가 있으면 제거
    	  	  	$img.attr('src', src.replace('_c.', '.'));
    	  	} else {
    	  	  	// 비활성 버튼: _c 가 없으면 추가
    	  	  	if (!/_c\./.test(src)) {
    	  	  	  	$img.attr('src', src.replace(/(\.[^\.]+)$/, '_c$1'));
    	  	  	}
    	  	}
    	});
	    // 3) 컨텐츠 영역 전환 (버튼 순서와 같은 index)
	    var idx = $('.ad_set_btn').index($this);
	    $('.ad_set_cont_wrap')
	      	.removeClass('ad_set_cont_wrap_act')
	      	.eq(idx)
	      	.addClass('ad_set_cont_wrap_act');
	});



















	const socket = io.connect('{{ ChatIoUri }}', {
		transports: ['polling'],  // 웹소켓보다 polling만 허용
		forceNew: true
	});

	// 연결 성공 시
	socket.on('connect', function () {
		//관리자가 채팅쳤을때
		body.off('click', '.chat_send_btn');
		body.on('click', '.chat_send_btn', function () {
		    var msg= $.trim($('.admin_input').val());
			var type= 'admin';
			var rn= '123456';//data-rn으로 가져와야함
			$.post(DomainUri+'/AdminCon/Chat',{
				msg:msg,
				rn:rn,
			},function(data){
				var tmpArr=JSON.parse(data);
				var objResult = tmpArr.result;
				var objData = tmpArr.data;
				//console.log(tmpArr)
				if(objResult=="t"){
					dataFrom=[{
						type: objData.type ,
						time: objData.time,
						msg: msg ,
						rn: rn,
					}];
					socket.emit('LiveChat', dataFrom);
				}else{
					pAlert(tmpArr.msg);
				}
			});
		});


		//관리자가 회원삭제했을때
		body.off('click', '.user_del_btn');
		body.on('click', '.user_del_btn', function () {
			var rn= '123456';//data-rn으로 가져와야함
			$.post(DomainUri+'/AdminCon/ClientDel',{
				rn:rn
			},function(data){
				var tmpArr=JSON.parse(data);
				var objResult = tmpArr.result;
				var objData = tmpArr.data;
				//console.log(tmpArr)
				if(objResult=="t"){
					socket.emit('ClientDelByAdmin');
				}else{
					pAlert(tmpArr.msg);
				}
			});

			socket.emit('test', { dddd: 'ff' });
		});

		//유저가 생성됐을때 채팅목록에 뿌리기
		socket.on('NewClient', function(arr) {
	    	console.log('NewClient')
	    	console.log(arr)
	  	});

		socket.on('LiveChat', function(arr) {
	    	console.log('LiveChat')
	    	console.log(arr)
			//채팅방안에 채팅뿌리기
			//채팅리스트에 최신댓글이랑 시간 뿌리기
	  	});

	});

});
</script>
{% endblock %}
