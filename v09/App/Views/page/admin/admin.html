{% extends "index.html" %}
{% block content %}
<link rel="stylesheet" href="{{DomainUri}}/source/css/admin.css?v={{ "now"|date("Y-m-d H:i:s") }}">

<style>
:root {
  --maincolor: #725CAD;
  --subcolor: #eee;
  --bgcolor: #3C3C3C;
}
body{
	width: 100vw;
	height: 100vh;
	min-width: 1000px;
	min-height: 600px;
}
.admin_wrap {
  	width: 100%;
  	height: 100%;
  	background-color: var(--bgcolor);
  	display: flex;
  	flex-wrap: wrap;
  	gap: 10px;
  	padding: 15px 25px 5px 25px;
}

.ad_main_txt_box{
	width: 100%;
	height: 35px;
}
.ad_main_txt{
	font-size: 30px;
	color: #fff;
	font-weight: 600;
}

.ad_le_wrap {
  	width: 270px;
  	height: calc(100% - 75px);
  	border: 2px solid var(--maincolor);
  	border-radius: 15px;
}

.ad_ri_wrap {
	width: calc(100% - 280px);
  	height: calc(100% - 75px);
  	border: 2px solid var(--maincolor);
  	border-radius: 15px;
	padding: 10px;
	display: flex;
	justify-content: space-between;
	flex-wrap: wrap;
}
.ad_bot_wrap {
	width: 100%;
	text-align: right;
}
.ad_bot_txt {
	font-size: 12px;
	color: #fff;
}
.ad_chat_list_wrap {
  height: 100%;
  width: 100%;
  padding: 14px 11px;
  overflow-y: scroll;
  scrollbar-width: none; /* Firefox */
}

.ad_chat_list_wrap::-webkit-scrollbar {
  display: none; /* Chrome, Safari */
}
.ad_chat_box{
	width: 100%;
	height: 65px;
	border: 2px solid var(--maincolor);
  	border-radius: 10px;
  	background-color: rgba(92, 79, 127, 0.49);
	margin-bottom: 10px;
	display: flex;
	justify-content: space-between;
}
.ad_chat_box_act{
	background-color: #402b5f;
}

.ad_chat_le_box{width: 65px;}
.ad_chat_le_img{
	display: block;
    width: 100%;
    height: 100%;
    padding: 8px 11px 11px 11px;
	}
.ad_chat_ri_box{
	width: calc(100% - 65px);
	height: 100%;
	display: flex;
	flex-wrap: wrap;
	align-items: initial;
	padding-right: 8px;
}
.ad_chat_ri_top_box{
    padding-top: 5px;
	width: 100%;
	display: flex;
	justify-content: space-between;
	align-items: center;

}

.ad_chat_ri_user_txt{
	overflow: hidden;
	white-space: nowrap;
	text-overflow: ellipsis;
	font-size: 12px;
}
.ad_chat_ri_time_txt{
	font-size: 10px;
	color: #989898;
	min-width: 47px;
	max-width: 47px;
}
.ad_chat_ri_txt{
	font-size: 13px;
}

.ad_chat_ri_bot_box{
	width: 100%;
}

.ad_set_wrap{
	border: 1px solid #646464;
	border-radius: 10px;
	padding: 10px;
	width: 153px;
	height: 100%;
}
.ad_set_box{
	width: 100%;
	height: 39px;
	margin-bottom: 10px;
}
.ad_set_btn{
	display: flex;
	align-items: center;
	width: 100%;
	height: 100%;
	background-color: #fff;
	border-radius: 7px;
	padding-left: 14px;
}
.ad_set_img{
	width: 21px;
	height: 21px;

}
.set_btn_txt{
	font-size: 14px;
	color: #4a4a4a;
	font-weight: 400;
	padding-left: 10px;
}

.ad_set_btn_act{
	background-color: var(--maincolor);
}
.ad_set_btn_act .set_btn_txt{
	color: #fff;
	font-weight: 500;
}
.ad_set_btn_act:hover{
	color: #fff!important;
}

.ad_set_cont_wrap{
	width: calc(100% - 163px);
	display: none;
	height: 100%;

}

.ad_set_cont_user_list_wrap{
	height: 100%;
	width: 100%;
	display: flex;
	justify-content: space-between;
}
.ad_set_cont_wrap_act{
	display: block;
}
.ad_set_user_list_dt_box{
	border: 1px solid #646464;
	border-radius: 10px;
	width: calc(100% - 210px);
	height: 100%;
}
.ad_set_user_list_box{
	border: 1px solid #646464;
	border-radius: 10px;
	width: 200px;
	height: 100%;
	overflow-y: auto;
	scrollbar-width: none;
}

.ad_set_user_list_img_box{
	display: flex;
	align-items: center;
	justify-content: center;
	flex-wrap: wrap;
	padding: 20px 0 0 0;

}

.ad_set_user_list_img{
	width: 160px;
	height: 160px;
}
.ad_set_user_list_txt_box{
	width: 100%;
	text-align: center;
	padding: 35px 10px 0 10px;
}
.ad_set_user_list_txt_box span{
	width: 100%;
}
.ad_set_user_list_txt{
	font-size: 13px;
	color: #fff;
	padding-bottom: 7px;
}
.ad_set_user_list_txt_cont{
	font-size: 15px;
	color: #fff;
	font-weight: 500;
	line-height: 1.3;
}

.data_table_wrap{
	width: 100%;
	height: 100%;
	overflow-y: auto;
	padding: 10px;
}

.p_table .p_td_status{
	width: 60px!important;
}
.p_table .td_status_2{
	color: #e16464;
}
.p_table .p_td_createTime{
	width: 160px!important;
}

.ad_ri_exit_wrap{
	width: 100%;
	height: 30px;
	display: flex;
	justify-content: start;
	align-items: start;
	padding-left: 7px;
}
.ad_ri_exit_brn{
	display: flex;
	align-items: center;
}
.ad_ri_exit_brn_img{
	width: 30px;
	height: 30px;
	cursor: pointer;
}
.exit_brn_txt{
	font-size: 17px;
	color: #fff;
	font-weight: 500;
	padding-left: 7px;
}

.ad_chat_de_box{
	width: 100%;
	height: calc(100% - 45px);
	display: flex;
	justify-content: space-between;
}
.ad_chat_de_cont_box{
	width: calc(100% - 210px);
	height: 100%;
	background-color: #F4F4F4;
	border-radius: 10px;
	padding: 10px;
	display: flex;
	flex-wrap: wrap;
}
.ad_chat_de_cont_chat_box{
	width: 100%;
	height: calc(100% - 100px);
	overflow-y: auto;
	scrollbar-width: none;
	padding: 10px 15px;
}

.chat_msg_box{
	padding-bottom: 30px;
}

.chat_client_msg_box{
	display: flex;
	align-items: start;
}
.chat_client_msg_img_box{
	padding-right: 10px;
}
.chat_client_msg_img{
	width: 40px;
	height: 40px;
}
.chat_client_msg_sb_box{
	background-color: #DCCFFF;
	border-radius: 10px;
	padding: 11px 18px;
	max-width: 65%;
}
.chat_client_msg_text{
	font-size: 14px;
	color: #444;
	font-weight: 500;
	line-height: 1.5;
}

.ad_set_user_list_cont{
	height: 100%;
}

.ad_set_user_list_cont_txt_box{
	height: calc(100% - 40px);
}

.ad_chat_user_de_del_btn_box{
	padding: 0 10px;
	height: 40px;
	display: flex;
	justify-content: flex-end;
}
.user_del_btn{
	height: 28px;
    width: 78px;
    border-radius: 0;
    background-color: #9c1414;
}
.user_del_btn span{
	font-size: 13px;
	font-weight: 400;
}

.chat_admin_msg_box{
	display: flex;
	align-items: start;
	justify-content: flex-end;
}
.chat_admin_msg_img_box{
	padding-left: 10px;
}
.chat_admin_msg_sb_box{
	background-color: #fff;
	border-radius: 10px;
	padding:  11px 18px;
	max-width: 65%;

}
.chat_admin_msg_text{
	font-size: 14px;
	color: #444;
	font-weight: 500;
	line-height: 1.5;
}
.chat_admin_msg_img{
	width: 40px;
	height: 40px;
}

.chat_client_timer_box,.chat_admin_timer_box{
	padding: 4px 6px;
	display: flex;
	align-items: flex-end;
	height: -webkit-fill-available;

}
.chat_admin_timer_text,.chat_client_timer_text{
	font-size: 12px;
	color: #989898;
}

.ad_chat_de_cont_send_box{
	width: 100%;
	height: 100px;
	background-color: #fff;
	border: 2px solid var(--maincolor);
	border-radius: 10px;
	padding: 10px 6px 5px 12px;
}
.send_chat{
	width: 100%;
	height: calc(100% - 35px);
	resize: none;
	font-size: 16px;
	color: #333;
	font-weight: 500;

}
.chat_send_btn_box{
	height: 35px;
	display: flex;
	align-items: center;
	justify-content: flex-end;
}

.ad_set_block_dt_box{
	height: 160px;
}
.ad_set_block_box{
	height: calc(100% - 160px);
	width: 100%;
	border: 1px solid #646464;
    border-radius: 15px;
    padding: 10px;
}
.block_textarea{
	background-color: #5A5A5A;
	border: 1px solid #646464;
	border-radius: 10px;
	padding: 10px;
	width: 100%;
	height: 100px;
	resize: none;
	font-size: 15px;
	line-height: 1.4;
	color:#fff;
	font-weight: 600;
}
.block_textarea::placeholder {
	color: #fff;
}
.block_save_btn_box{
	display: flex;
	align-items: center;
	justify-content: flex-end;
	padding-top: 10px;
}
.block_ud_btn_box{
	display: flex;
	align-items: center;
	justify-content: space-between;
	padding-top: 10px;
}
.block_ud_ri_btn_box{
	display: flex;
	align-items: center;
	justify-content: flex-end;
}
.block_be_btn{
	width: 87px;
	background-color: #f5f5f5;
	border: 1px solid #646464;
}
.block_be_btn span{
	color: #333 !important;;
}
.block_be_btn span:hover{
	color: #333 !important;;
}
.block_save_btn,.block_ud_btn,.block_del_btn{
	width: 80px;
	margin-left: 7px;
}









.ellipsis {
  display: inline-block;
  width: 100%;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.ellipsis br {
  display: none;
}
</style>

<div class="admin_wrap">
	<div class="ad_main_txt_box">
		<span class="ad_main_txt">관리자가 되어 채팅을 실시간으로 확인하세요!</span>
	</div>
	<div class="ad_le_wrap">
		<div class="ad_chat_list_wrap">
				{% if chatList %}
					{% for key in chatList %}
						<a href="javascript:void(0);" class="ad_chat_box" data-rn="{{key.rn}}" data-create-time="{{key.time}}">
							<div class="ad_chat_le_box">
								<img src="{{DomainUri}}/source/img/icons/c_user.png" alt="유저 이미지" class="ad_chat_le_img">
							</div>
							<div class="ad_chat_ri_box">
								<div class="ad_chat_ri_top_box">
									<span class="ad_chat_ri_user_txt f_white ellipsis">{{key.name}}</span>
									<span class="ad_chat_ri_time_txt f_white">{{key.formatted_time}}</span>
								</div>
								<div class="ad_chat_ri_bot_box">
									<span class="ad_chat_ri_txt f_white ellipsis">{{ key.last_msg|striptags }}</span>
								</div>
							</div>
						</a>
					{% endfor %}
				{% else %}
				{% endif %}
		</div>
	</div>
	<div class="ad_ri_wrap ad_chat_set_wrap">
		<div class="ad_set_wrap">
			<div class="ad_set_box">
				<a href="javascript:void(0);" class="ad_set_btn ad_set_btn_act">
					<img src="{{DomainUri}}/source/img/icons/user.png" alt="회원 목록 아이콘" class="ad_set_img">
					<span class="set_btn_txt">회원 목록</span>
				</a>
			</div>
			<div class="ad_set_box">
				<a href="javascript:void(0);" class="ad_set_btn">
					<img src="{{DomainUri}}/source/img/icons/block_c.png" alt="금지어 설정 아이콘" class="ad_set_img">
					<span class="set_btn_txt">금지어 설정</span>
				</a>
			</div>
			{# <div class="ad_set_box">
				<a href="javascript:void(0);" class="ad_set_btn">
					<img src="{{DomainUri}}/source/img/icons/chat_c.png" alt="빠른 답변 아이콘" class="ad_set_img">
					<span class="set_btn_txt">빠른 답변</span>
				</a>
			</div> #}
		</div>
		<div class="ad_set_cont_wrap ad_set_cont_wrap_act">
			<div class="ad_set_cont_user_list_wrap">
				<div class="ad_set_user_list_dt_box">
					<div class="data_table_wrap">
						<div class="p_table_box user_data_table_box">
							<table class="p_table user_dataTable">
								<thead>
									<th>idx</th>
									<th>회원명</th>
									<th>회원상태</th>
									<th>가입일</th>
								</thead>
								<tbody class="settlement_tbody">
								</tbody>
							</table>
						</div>
					</div>
				</div>
				<div class="ad_set_user_list_box">
					<div class="ad_set_user_list_cont display_none">
						<div class="ad_set_user_list_cont_txt_box">
							<div class="ad_set_user_list_img_box">
								<img src="{{DomainUri}}/source/img/icons/c_user.png" 	alt="유저 이미지" class="ad_set_user_list_img">
							</div>
							<div class="ad_set_user_list_txt_box">
								<span class="ad_set_user_list_txt">닉네임</span>
								<span class="ad_set_user_list_txt_cont 	ad_set_user_list_username"></span>
							</div>
							<div class="ad_set_user_list_txt_box">
								<span class="ad_set_user_list_txt">가입일</span>
								<span class="ad_set_user_list_txt_cont 	ad_set_user_list_createtime"></span>
							</div>
							<div class="ad_set_user_list_txt_box">
								<span class="ad_set_user_list_txt">듣고 싶은 말</span>
								<span class="ad_set_user_list_txt_cont 	ad_set_user_list_talk"></span>
							</div>
						</div>
						<div class="ad_chat_user_de_del_btn_box">
							<a href="javascript:void(0);" class="p_btn user_del_btn">
								<span class="btn_txt">회원삭제</span>
							</a>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="ad_set_cont_wrap ad_set_cont_block_wrap">
			<div class="ad_set_block_dt_box">
				<textarea class="block_textarea" placeholder="금지어를 입력해 주세요.
입력하신 금지어는 사용자가 채팅에 작성할 경우 자동으로 필터링되어 노출되지 않습니다."></textarea>
				<div class="block_save_btn_box">
					<a href="javascript:void(0);" class="block_save_btn p_btn">
						<span class="block_btn_txt">저장</span>
					</a>
				</div>
				<div class="block_ud_btn_box display_none">
					<div class="block_ud_le_btn_box">
						<a href="javascript:void(0);" class="block_be_btn p_btn">
							<span class="block_btn_txt">새로 등록</span>
						</a>
					</div>
					<div class="block_ud_ri_btn_box">
						<a href="javascript:void(0);" class="block_ud_btn p_btn">
							<span class="block_btn_txt">수정</span>
						</a>
						<a href="javascript:void(0);" class="block_del_btn p_btn">
							<span class="block_btn_txt">삭제</span>
						</a>
					</div>
				</div>
			</div>
			<div class="ad_set_block_box">
				<div class="data_table_wrap">
					<div class="p_table_box block_data_table_box">
						<table class="p_table block_dataTable">
							<thead>
								<th>idx</th>
								<th>금지어</th>
							</thead>
							<tbody class="settlement_tbody">
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
		<div class="ad_set_cont_wrap ad_set_cont_quick_wrap">
			<div class="ad_set_quick_dt_box">
			</div>
			<div class="ad_set_quick_box">
			</div>
		</div>
	</div>
	<div class="ad_ri_wrap ad_chat_de_wrap display_none">
		<div class="ad_ri_exit_wrap">
			<a href="javascript:void(0);" class="ad_ri_exit_brn">
				<img src="{{DomainUri}}/source/img/icons/exit.png" alt="나가기" class="ad_ri_exit_brn_img">
				<span class="exit_brn_txt">나가기</span>
			</a>
		</div>
		<div class="ad_chat_de_box">
			<div class="ad_chat_de_cont_box">
				<div class="ad_chat_de_cont_chat_box">
				</div>
				<div class="ad_chat_de_cont_send_box">
					<form id="chatForm">
						<textarea class="send_chat" placeholder="유저에게 보낼 내용을 입력해주세요"></textarea>
						<div class="chat_send_btn_box">
							<button type="button" class="chat_send_btn p_btn">전송</button>
						</div>
					</form>
				</div>
			</div>
			<div class="ad_set_user_list_box ad_chat_de_cont_user_box">
				<div class="ad_set_user_list_cont">
					<div class="ad_set_user_list_img_box">
						<img src="{{DomainUri}}/source/img/icons/c_user.png" alt="유저 이미지" class="ad_set_user_list_img">
					</div>
					<div class="ad_set_user_list_txt_box">
						<span class="ad_set_user_list_txt">닉네임</span>
						<span class="chat_user_list_username ad_set_user_list_txt_cont"></span>
					</div>
					<div class="ad_set_user_list_txt_box">
						<span class="ad_set_user_list_txt">가입일</span>
						<span class="chat_user_list_createtime ad_set_user_list_txt_cont"></span>
					</div>
					<div class="ad_set_user_list_txt_box">
						<span class="ad_set_user_list_txt">듣고 싶은 말</span>
						<span class="chat_user_list_talk ad_set_user_list_txt_cont"></span>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="ad_bot_wrap">
		<span class="ad_bot_txt">해당 사이트는 PC 환경에 최적화되어 있으므로, 데스크톱 또는 노트북에서의 이용을 권장드립니다.</span>
	</div>
</div>
<script type="text/javascript">
$(document).ready(function () {
	const body = $('body');

	//const chatListData = {{ chatList|json_encode(constant('JSON_UNESCAPED_UNICODE'))|raw }};
    //console.log('chatList:', chatListData);

	var userDataTable;
	if (userDataTable instanceof $.fn.dataTable.Api) {
	    userDataTable.destroy();
		$('.user_dataTable').DataTable().destroy();
	}
	userDataTable=$('.user_dataTable').DataTable({
	    "order": [[0,'desc']],
	    "iDisplayLength":50,
	    "ajax" : {
	        url:DomainUri+"/AdminCon/ClientDataTable",
	        type:"POST",
	        data:function(d){},
	   	},
	   	"columns": [
	        { "data": "idx", "class":"p_td_idx","orderable": false,"visible":false},
	        { "data": "name", "class":""},
	        { "data": "status", "class":"p_td_status"},
	        { "data": "create_time", "class":"p_td_createTime"},
	        { "data": "talk", "class":"","visible":false},
	        { "data": "rn", "class":"","visible":false},
	    ],
    	"initComplete": function(settings, data, dataIndex){
    		pTableInitComplete(this,'y');

		},
		fnRowCallback: function(nRow, aData, iDisplayIndex, iDisplayIndexFull){
			var tdStatus='';
			if(aData['status']=='정상'){
				tdStatus='td_status_1';
            }else if(aData['status']=='삭제'){
				tdStatus='td_status_2';
            }
			$('.p_td_status', nRow).html('<span class="f_small '+tdStatus+'">'+aData['status']+'</span>');
		},
		drawCallback: function( settings ) {
		},
	});

	$('.user_dataTable tbody').on('click', 'tr', function(){
 	    var data = userDataTable.row(this).data();

 	    var $box = $('.ad_set_user_list_cont');
 	    $box.removeClass('display_none');

 	    $box.find('.ad_set_user_list_username')
 	        .text(data.name);

 	    $box.find('.ad_set_user_list_createtime')
 	        .text(data.create_time);

 	    $box.find('.ad_set_user_list_talk')
 	       .text(data.talk);

		$box.find('.user_del_btn')
        	.attr('data-rn', data.rn);

    	// $box.find('.ad_set_user_list_img')
    	//     .attr('src', data.imageUrl || '{{DomainUri}}/source/img/icons/c_user.png');
  	});



	var blockDataTable;
	if (blockDataTable instanceof $.fn.dataTable.Api) {
	    blockDataTable.destroy();
		$('.block_dataTable').DataTable().destroy();
	}
	blockDataTable=$('.block_dataTable').DataTable({
	    "order": [[1,'desc']],
	    "iDisplayLength":50,
	    "ajax" : {
	        url:DomainUri+"/AdminCon/BlockDataTable",
	        type:"POST",
	        data:function(d){},
	   	},
	   	"columns": [
	        { "data": "idx", "class":"p_td_idx","orderable": false,"visible":false},
	        { "data": "words", "class":""},
	    ],
    	"initComplete": function(settings, data, dataIndex){
    		pTableInitComplete(this,'y');

		},
		fnRowCallback: function(nRow, aData, iDisplayIndex, iDisplayIndexFull){
		},
		drawCallback: function( settings ) {
		},
	});

	function refreshBlockPage() {
	  	$('.block_save_btn_box').removeClass('display_none');
	    $('.block_ud_btn_box').addClass('display_none');
		$('.block_textarea').val('');
		refreshBlockTable();
	}

	$('.block_dataTable tbody').on('click', 'tr', function(){
 	    var data = blockDataTable.row(this).data();
		$('.block_textarea').val(data.words);
 	    $('.block_ud_btn_box').removeClass('display_none');
		$('.block_save_btn_box').addClass('display_none');
		$('.block_del_btn').attr('data-idx', data.idx);
		$('.block_ud_btn').attr('data-idx', data.idx);
  	});

	body.off('click', '.block_be_btn');
	body.on('click', '.block_be_btn', function (e) {
	    e.preventDefault();
	    refreshBlockPage();
	});

	body.off('click', '.block_ud_btn');
	body.on('click', '.block_ud_btn', function () {
		var $this = $(this);
		if (!$this.data('idx')) {
		    return pAlert('잘못된 접근입니다. 새로고침 후 다시 시도해 주세요.');
		}
		var idx=  $this.data('idx');
		var words  = $.trim($('.block_textarea').val());
		if (!words) {
			return pAlert('금지어를 입력해 주세요.');
		}

		$.confirm({
			title:'금지어 수정',
			content:'해당 금지어를 수정하시겠습니까?',
			closeIcon: false,
			useBootstrap: false,
			backgroundDismiss: false,
			boxWidth: '430px',
			buttons: {
				cancel:{
					text:"취소",
				},
				'confirm': {
					text: '확인',
					btnClass: 'btn-blue bo_submit',
					keys:['enter'],
					action:function(){
						$.post(DomainUri+'/AdminCon/BlockUpdate',{
							idx:idx,
							words:words,
						},function(data){
							var tmpArr=JSON.parse(data);
							var objResult = tmpArr.result;
							var objData = tmpArr.data;
							if(objResult=="t"){
								refreshBlockTable();
								pAlert('수정이 완료되었습니다.');
							}else{
								pAlert(tmpArr.msg);
							}
						});
					}
				},
			}
		});

	});

	body.off('click', '.block_del_btn');
	body.on('click', '.block_del_btn', function () {
		var $this = $(this);
		if (!$this.data('idx')) {
		    return pAlert('삭제할 금지어를 선택해주세요');
		}
		var idx=  $this.data('idx');
		$.confirm({
			title:'금지어 삭제',
			content:'해당 금지어를 삭제하시겠습니까?',
			closeIcon: false,
			useBootstrap: false,
			backgroundDismiss: false,
			boxWidth: '430px',
			buttons: {
				cancel:{
					text:"취소",
				},
				'confirm': {
					text: '확인',
					btnClass: 'btn-blue bo_submit',
					keys:['enter'],
					action:function(){
						$.post(DomainUri+'/AdminCon/BlockDel',{
							idx:idx
						},function(data){
							var tmpArr=JSON.parse(data);
							var objResult = tmpArr.result;
							var objData = tmpArr.data;
							if(objResult=="t"){
								refreshBlockPage();
								refreshBlockTable();
								pAlert('삭제가 완료되었습니다.');
							}else{
								pAlert(tmpArr.msg);
							}
						});
					}
				},
			}
		});

	});

	body.off('click', '.block_save_btn');
	body.on('click', '.block_save_btn', function () {
		var words  = $.trim($('.block_textarea').val());
		$.confirm({
			title:'금지어 등록',
			content:'해당 금지어를 등록하시겠습니까?',
			closeIcon: false,
			useBootstrap: false,
			backgroundDismiss: false,
			boxWidth: '430px',
			buttons: {
				cancel:{
					text:"취소",
				},
				'confirm': {
					text: '확인',
					btnClass: 'btn-blue bo_submit',
					keys:['enter'],
					action:function(){
						$.post(DomainUri+'/AdminCon/BlockInsert',{
							words:words
						},function(data){
							var tmpArr=JSON.parse(data);
							var objResult = tmpArr.result;
							var objData = tmpArr.data;
							if(objResult=="t"){
								$('.block_textarea').val('');
								refreshBlockTable();
								pAlert('등록이 완료되었습니다.');
							}else{
								pAlert(tmpArr.msg);
							}
						});
					}
				},
			}
		});

	});

	body.off('click', '.ad_ri_exit_brn');
	body.on('click', '.ad_ri_exit_brn', function (e) {
	    e.preventDefault();
	    $('.ad_chat_set_wrap').removeClass('display_none');
	    $('.ad_chat_de_wrap').addClass('display_none');
	    $('.ad_chat_box').removeClass('ad_chat_box_act');
	});

	body.off('click', '.ad_chat_box');
	body.on('click', '.ad_chat_box', function (e) {
  	  	e.preventDefault();
  	  	var $this = $(this);
  	  	$('.ad_chat_de_wrap').removeClass('display_none');
  	  	$('.ad_chat_set_wrap').addClass('display_none');
  	  	$('.ad_chat_box').removeClass('ad_chat_box_act');
  	  	$this.addClass('ad_chat_box_act');

		var rn=  $('.ad_chat_box_act').data('rn');
		$.post(DomainUri+'/AdminCon/GetChat',{
			rn:rn
		},function(data){
			var tmpArr=JSON.parse(data);
			var objResult = tmpArr.result;
			var objData = tmpArr.data;
			if (objResult !== "t") {
    		  	return pAlert(tmpArr.msg);
    		}
    		$('.chat_user_list_username')
    		    .text(objData.userName);

    		$('.chat_user_list_createtime')
    		    .text(objData.userCreateTime);

    		$('.chat_user_list_talk')
    		    .text(objData.userTalk && objData.userTalk.trim()
    		          ? objData.userTalk
    		          : '-');
			// 1) 채팅 박스 컨테이너 가져와서 초기화
    		var $chatBox = $('.ad_chat_de_cont_chat_box');
    		$chatBox.empty();
			console.log(objData.chatList)
			// 2) chatList 순회하며 말풍선 생성
    		$.each(objData.chatList, function(i, chat){
    		  	var bubbleHtml = '';
    		  	if (chat.type === 1) {
    		  	  // 관리자 메시지
    		  	  bubbleHtml = ''
    		  	    + '<div class="chat_admin_msg_box chat_msg_box">'
    		  	    +   '<div class="chat_admin_timer_box">'
    		  	    +     '<span class="chat_admin_timer_text">' + chat.create_time + 	'</span>'
    		  	    +   '</div>'
    		  	    +   '<div class="chat_admin_msg_sb_box">'
    		  	    +     '<span class="chat_admin_msg_text">' + chat.msg + '</span>'
    		  	    +   '</div>'
    		  	    +   '<div class="chat_admin_msg_img_box">'
    		  	    +     '<img src="' + DomainUri + '/source/img/icons/man.png" '
    		  	    +          'alt="관리자 이미지" class="chat_admin_msg_img">'
    		  	    +   '</div>'
    		  	    + '</div>';
    		  	}
    		  	else if (chat.type === 2) {
    		  	  // 유저 메시지
    		  	  bubbleHtml = ''
    		  	    + '<div class="chat_client_msg_box chat_msg_box">'
    		  	    +   '<div class="chat_client_msg_img_box">'
    		  	    +     '<img src="' + DomainUri + '/source/img/icons/c_user.png" '
    		  	    +          'alt="유저 이미지" class="chat_client_msg_img">'
    		  	    +   '</div>'
    		  	    +   '<div class="chat_client_msg_sb_box">'
    		  	    +     '<span class="chat_client_msg_text">' + chat.msg + '</span>'
    		  	    +   '</div>'
    		  	    +   '<div class="chat_client_timer_box">'
    		  	    +     '<span class="chat_client_timer_text">' + chat.create_time + 	'</span>'
    		  	    +   '</div>'
    		  	    + '</div>';
    		  	}
    		  	// 3) 컨테이너에 붙이기
    		  	$chatBox.append(bubbleHtml);
			});
			// 4) 스크롤을 맨 아래로 내리기
    		$chatBox.scrollTop($chatBox.prop('scrollHeight'));
		});
  	});

	body.off('click', '.ad_set_btn');
	body.on('click', '.ad_set_btn', function (e) {
	    e.preventDefault();
	    var $this = $(this);
	    // 1) 버튼 활성화 클래스 토글
	    $('.ad_set_btn').removeClass('ad_set_btn_act');
	    $this.addClass('ad_set_btn_act');
	    // 2) 이미지 src 업데이트 (_c 붙였다 떼었다)
	    $('.ad_set_btn').each(function(){
    	  	var $img = $(this).find('.ad_set_img');
    	  	var src  = $img.attr('src');
    	  	if ($(this).hasClass('ad_set_btn_act')) {
    	  	  	// 활성 버튼: _c 가 있으면 제거
    	  	  	$img.attr('src', src.replace('_c.', '.'));
    	  	} else {
    	  	  	// 비활성 버튼: _c 가 없으면 추가
    	  	  	if (!/_c\./.test(src)) {
    	  	  	  	$img.attr('src', src.replace(/(\.[^\.]+)$/, '_c$1'));
    	  	  	}
    	  	}
    	});
	    // 3) 컨텐츠 영역 전환 (버튼 순서와 같은 index)
	    var idx = $('.ad_set_btn').index($this);
	    $('.ad_set_cont_wrap')
	      	.removeClass('ad_set_cont_wrap_act')
	      	.eq(idx)
	      	.addClass('ad_set_cont_wrap_act');

		refreshBlockPage();
		refreshClientTable();
	});

	// 정렬 함수
	function sortChatBoxes() {
	  	var $wrap = $('.ad_chat_list_wrap');
	  	var $boxes = $wrap.children('.ad_chat_box').get();
	  	$boxes.sort(function(a, b){
	  	  	var at = new Date($(a).attr('data-create-time')).getTime();
	  	  	var bt = new Date($(b).attr('data-create-time')).getTime();
	  	  	return bt - at;  // 내림차순: 최신이 위로
	  	});
	  	$.each($boxes, function(_, box){
	  	  	$wrap.append(box);
	  	});
	}

	function refreshClientTable() {
	  	if (userDataTable instanceof $.fn.dataTable.Api) {
	  	  	userDataTable.ajax.reload(null, false);
	  	}
	}
	function refreshBlockTable() {
	  	if (blockDataTable instanceof $.fn.dataTable.Api) {
	  	  	blockDataTable.ajax.reload(null, false);
	  	}
	}




	const socket = io.connect('{{ ChatIoUri }}', {
		transports: ['polling'],  // 웹소켓보다 polling만 허용
		forceNew: true
	});


	// 연결 성공 시
	socket.on('connect', function () {
		// 이미 바인딩된 적 있으면 되돌아가서 중복 방지
		if (window.chatHandlersBound) return;
		window.chatHandlersBound = true;

		// 1) 전송 로직을 함수로 분리
		function sendChat() {
			var msg  = $.trim($('.send_chat').val());
			var rn   = $('.ad_chat_box_act').data('rn');
			if (!msg) {
				return ;
			}
			if (!rn) {
				return pAlert('잘못된 접근입니다. 새로고침 후 다시 시도해주세요');
			}

			$.post(DomainUri + '/AdminCon/Chat', {
				msg: msg,
				rn:  rn
			}, function(data){
				var tmpArr    = JSON.parse(data);
				var objResult = tmpArr.result;
				var objData   = tmpArr.data;

				if (objResult === "t") {
					// 1) 소켓 전송
					socket.emit('LiveChat', [{
						type:             objData.type,
						formattime:         objData.formattime,
						chat_list_time:     objData.chat_list_time,
						time:             objData.time,
						msg:              msg,
						rn:               rn
					}]);

					// 2) 상세 채팅 말풍선 추가
					var bubbleHtml = ''
					+ '<div class="chat_admin_msg_box chat_msg_box">'
					+   '<div class="chat_admin_timer_box">'
					+     '<span class="chat_admin_timer_text">' + objData.formattime + '</span>'
					+   '</div>'
					+   '<div class="chat_admin_msg_sb_box">'
					+     '<span class="chat_admin_msg_text">' + msg + '</span>'
					+   '</div>'
					+   '<div class="chat_admin_msg_img_box">'
					+     '<img src="' + DomainUri + '/source/img/icons/man.png" '
					+          'alt="유저 이미지" class="chat_admin_msg_img">'
					+   '</div>'
					+ '</div>';
					var $chatBox = $('.ad_chat_de_cont_chat_box');
					$chatBox.append(bubbleHtml)
							.scrollTop($chatBox.prop('scrollHeight'));

					// 3) 리스트 미리보기 업데이트
					var $active = $('.ad_chat_box_act');
					$active
					.find('.ad_chat_ri_txt').text(msg).end()
					.find('.ad_chat_ri_time_txt').text(objData.chat_list_time).end()
					.attr('data-create-time', objData.time);
					sortChatBoxes();

					// 4) 입력창 초기화
					$('.send_chat').val('');

				} else {
					pAlert(tmpArr.msg);
				}
			});
		}

		$('#chatForm')
		.off('submit.chat')
		.on ('submit.chat', function(e){
			e.preventDefault();
			sendChat();
		});

		let isThrottled = false;

		function throttledSendChat() {
		if (isThrottled) return;
		isThrottled = true;
		setTimeout(() => {
			sendChat();
			isThrottled = false;
		}, 300);
		}

		body
		.off('click.sendChat', '.chat_send_btn')
		.on ('click.sendChat', '.chat_send_btn', function(e){
			e.preventDefault();
			throttledSendChat();
		});

		body
		.off('keyup.sendChat', '.send_chat')
		.on ('keyup.sendChat', '.send_chat', function(e){
			if (e.key === 'Enter' && !e.shiftKey) {
			e.preventDefault();
			throttledSendChat();
			}
		});


		//관리자가 회원삭제했을때
		body.off('click', '.user_del_btn');
		body.on('click', '.user_del_btn', function () {
			var $this = $(this);
			if (!$this.data('rn')) {
			    return pAlert('삭제할 회원을 선택해주세요');
			}
			var rn=  $this.data('rn');
			$.confirm({
				title:'회원 삭제',
				content:'해당 회원을 삭제하시겠습니까? </br> 삭제된 회원은 다시 복구할 수 없으며 해당 채팅 내용은 모두 삭제됩니다.',
				closeIcon: false,
				useBootstrap: false,
				backgroundDismiss: false,
				boxWidth: '430px',
				buttons: {
					cancel:{
						text:"취소",
					},
					'confirm': {
						text: '확인',
						btnClass: 'btn-blue bo_submit',
						keys:['enter'],
						action:function(){
							$.post(DomainUri+'/AdminCon/ClientDel',{
								rn:rn
							},function(data){
								var tmpArr=JSON.parse(data);
								var objResult = tmpArr.result;
								var objData = tmpArr.data;
								if(objResult=="t"){
									socket.emit('ClientDelByAdmin');
									refreshClientTable();
									pAlert('삭제가 완료되었습니다.');
                            		$('.ad_chat_box[data-rn="' + rn + '"]').remove();
								}else{
									pAlert(tmpArr.msg);
								}
							});
						}
					},
				}
			});

		});

		socket.on('ClientDelByClient', function(arr) {
	    	//console.log('ClientDelByClient')
	    	$('.ad_chat_box[data-rn="' + arr.rn + '"]').remove();
	  	});


		//유저가 생성됐을때 채팅목록에 뿌리기
		socket.on('NewClient', function(payload) {
	    	console.log('NewClient')
	    	console.log(payload)
			var client = Array.isArray(payload) ? payload[0] : payload;
			var bubbleHtml = ''
			+ '<a href="javascript:void(0);" class="ad_chat_box"'
			+     ' data-rn="' + client.rn + '"'
			+     ' data-create-time="' + client.time + '">'
			+   '<div class="ad_chat_le_box">'
			+     '<img src="' + DomainUri + '/source/img/icons/c_user.png"'
			+          ' alt="유저 이미지" class="ad_chat_le_img">'
			+   '</div>'
			+   '<div class="ad_chat_ri_box">'
			+     '<div class="ad_chat_ri_top_box">'
			+       '<span class="ad_chat_ri_user_txt f_white ellipsis">'
							+ client.name +
					'</span>'
			+       '<span class="ad_chat_ri_time_txt f_white">'
							+ client.formatted_time +
					'</span>'
			+     '</div>'
			+     '<div class="ad_chat_ri_bot_box">'
			+       '<span class="ad_chat_ri_txt f_white ellipsis">'
							+ client.msg +
					'</span>'
			+     '</div>'
			+   '</div>'
			+ '</a>';
			$('.ad_chat_list_wrap').prepend(bubbleHtml);
        	sortChatBoxes();
	  	});

		socket.on('LiveChat', function(payload) {
			console.log('LiveChat', payload);

			// payload를 항상 배열로 처리
			var clients = Array.isArray(payload) ? payload : [payload];

			// 캐싱
			var $activeBox      = $('.ad_chat_box_act');
			var $chatContainer  = $('.ad_chat_de_cont_chat_box');

			clients.forEach(function(client) {
				var bubbleHtml = '';

				// ── 1) 말풍선 생성 ──
				if (client.type === 2) {
				// 유저 메시지
				bubbleHtml = ''
					+ '<div class="chat_client_msg_box chat_msg_box">'
					+   '<div class="chat_client_msg_img_box">'
					+     '<img src="' + DomainUri + '/source/img/icons/c_user.png" '
					+          'alt="유저 이미지" class="chat_client_msg_img">'
					+   '</div>'
					+   '<div class="chat_client_msg_sb_box">'
					+     '<span class="chat_client_msg_text">' + client.msg + '</span>'
					+   '</div>'
					+   '<div class="chat_client_timer_box">'
					+     '<span class="chat_client_timer_text">' + client.formattime + '</span>'
					+   '</div>'
					+ '</div>';
				}
				else if (client.type === 1) {
				// 관리자 메시지
				bubbleHtml = ''
					+ '<div class="chat_admin_msg_box chat_msg_box">'
					+   '<div class="chat_admin_timer_box">'
					+     '<span class="chat_admin_timer_text">' + client.formattime + '</span>'
					+   '</div>'
					+   '<div class="chat_admin_msg_sb_box">'
					+     '<span class="chat_admin_msg_text">' + client.msg + '</span>'
					+   '</div>'
					+   '<div class="chat_admin_msg_img_box">'
					+     '<img src="' + DomainUri + '/source/img/icons/man.png" '
					+          'alt="관리자 이미지" class="chat_admin_msg_img">'
					+   '</div>'
					+ '</div>';
				}

				// 활성 방 안이라면 말풍선 추가 & 스크롤
				if ($activeBox.length && bubbleHtml) {
				$chatContainer.append(bubbleHtml)
								.scrollTop($chatContainer.prop('scrollHeight'));
				}

				// ── 2) 채팅 리스트 최신화 ──
				var $item = $('.ad_chat_box[data-rn="' + client.rn + '"]');
				if ($item.length) {
				$item
					.find('.ad_chat_ri_txt').text(client.msg).end()
					.find('.ad_chat_ri_time_txt').text(client.chatListTime).end()
					.attr('data-create-time', client.time);
				}
			});

			// ── 3) 다시 정렬 ──
			sortChatBoxes();
		});

	});

});
</script>
{% endblock %}
